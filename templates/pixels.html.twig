{% extends "master.html.twig" %}

{% set title = 'Pixel Lookup' %}

{% block content %}
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">Search</h3>
                </div>
                <div class="box-body">
                    <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#search-custom">Custom</a></li>
                        <li><a data-toggle="tab" href="#search-by-id">By ID</a></li>
                    </ul>
                    <form class="tab-content">
                        <span>Leave any fields empty to ignore them.</span>
                        <div id="search-by-id" class="tab-pane">
                            <label>
                                Pixel ID
                                <input name="pixel-id" type="number" min="0" />
                            </label>
                        </div>
                        <div id="search-custom" class="tab-pane active">
                            <fieldset>
                                <label>
                                    Limit
                                    <input name="amount" type="number" min="0" value="100" />
                                </label>
                            </fieldset>
                            <fieldset>
                                <legend>Coordinate</legend>
                                <label><input type="radio" name="coordinate-search-type" value="range" checked/> Range</label>
                                <label><input type="radio" name="coordinate-search-type" value="exact" /> Exact</label>
                                <div data-section-name="coordinate-search-type" data-section-value="range">
                                    <div>
                                        <div class="coordinate-input-container">
                                            <input name="coords-from-x" class="small-input" type="number" min="0" placeholder="from x" />,
                                            <input name="coords-from-y" class="small-input" type="number" min="0" placeholder="from y" />
                                        </div>
                                        to
                                        <div class="coordinate-input-container">
                                            <input name="coords-to-x" class="small-input" type="number" min="0" placeholder="to x" />,
                                            <input name="coords-to-y" class="small-input" type="number" min="0" placeholder="to x" />
                                        </div>
                                    </div>
                                </div>
                                <div data-section-name="coordinate-search-type" data-section-value="exact">
                                    <div>
                                        <div class="coordinate-input-container">
                                            <input name="coords-exact-x" class="small-input" type="number" min="0" placeholder="x" />,
                                            <input name="coords-exact-y" class="small-input" type="number" min="0" placeholder="y" />
                                        </div>
                                    </div>
                                </div>
                                <span id="lblCoordinateFeedback" class="text-orange" style="display: none;"><i class="icon fa fa-warning"></i> Invalid</span>
                            </fieldset>
                            <fieldset>
                                <legend>Time range</legend>
                                <div>
                                    <label>
                                        Before
                                        <input name="before-date" type="date" />
                                        <input name="before-time" type="time" step=".001" />
                                        <span id="lblBeforeFeedback" class="text-orange" style="display: none;"><i class="icon fa fa-warning"></i> Invalid</span>
                                    </label>
                                </div>
                                <div>
                                    <label>
                                        After
                                        <input name="after-date" type="date" />
                                        <input name="after-time" type="time" step=".001" />
                                        <span id="lblAfterFeedback" class="text-orange" style="display: none;"><i class="icon fa fa-warning"></i> Invalid</span>
                                    </label>
                                </div>
                            </fieldset>
                            <fieldset>
                                <legend>Placers</legend>
                                <ul id="lstPlacers"></ul>
                            </fieldset>
                            <fieldset>
                                <legend>Colors</legend>
                                <div id="filter-colors" class="color-filter">Loading...</div>
                            </fieldset>
                            <fieldset>
                                <legend>Properties</legend>
                                <div><label class="pixel-prop"><input name="mostRecent" type="checkbox" /> Only most recent pixels</label></div>
                                <div><label class="pixel-prop"><input name="wasUndone" type="checkbox" /> Only undone pixels</label></div>
                                <div><label class="pixel-prop"><input name="undoAction" type="checkbox" /> Only pixels that are part of an undo</label></div>
                                <div><label class="pixel-prop"><input name="modAction" type="checkbox" /> Only pixels placed with placement overrides</label></div>
                                <div><label class="pixel-prop"><input name="rollbackAction" type="checkbox" /> Only pixels that are part of a rollback</label></div>
                            </fieldset>
                        </div>
                        <button id="btnQuery" class="btn btn-primary" disabled>Query</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">Results</h3>
                </div>
                <div class="box-body">
                    <div id="fetch-error-box" class="alert alert-error" style="display: none;">
                        <h4><i class="icon fa fa-times"></i> An error occurred</h4>
                        <span class="alert-error__text"></span><br/>
                        Please contact a developer. The error has been logged.
                    </div>
                    <div>
                        <b>Show fields</b>:
                        <label><input type="checkbox" data-toggle-column="4" checked /> Time</label>
                        <label><input type="checkbox" data-toggle-column="5" checked /> Is Most Recent</label>
                        <label><input type="checkbox" data-toggle-column="6" /> Was Undone</label>
                        <label><input type="checkbox" data-toggle-column="7" /> Is Undo</label>
                        <label><input type="checkbox" data-toggle-column="8" /> With Placement Override</label>
                        <label><input type="checkbox" data-toggle-column="9" /> Is Part of a Rollback</label>
                    </div>
                    <table id="tblPixels" class="table table-responsive table-bordered table-striped nowrap">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Placer</th>
                                <th>Coords</th>
                                <th>Color</th>
                                <th>Time</th>
                                <th>Is Most Recent</th>
                                <th>Was Undone</th>
                                <th>Is Undo</th>
                                <th>With Placement Override</th>
                                <th>Is Part of a Rollback</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="btn-group pull-right">
                        <button id="btnExportCSV" class="btn btn-default">Export as CSV</button>
                        <button id="btnExportJSON" class="btn btn-default">Export as JSON</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row board-preview" style="display: none;">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-header">
                    <h3 class="box-title">Board</h3>
                </div>
                <div class="box-body">
                    <div class="col-sm-3">
                        <p class="board-preview__range text-muted text-center">
                            <span class="board-preview__range__min"></span>
                            <i class="icon fa fa-arrow-right"></i>
                            <span class="board-preview__range__max"></span>
                        </p>
                        <div class="form-group">
                            <button id="btnBoardPreviewDownload" class="btn btn-default">Download as PNG</button>
                        </div>
                        <div class="form-group">
                            <label><input id="cbBoardPreviewBackground" type="checkbox" checked /> Show checkerboard pattern</label>
                        </div>
                        <div class="form-group">
                            <label><input id="cbBoardPreviewUserMode" type="checkbox" /> Color-coded users mode</label>
                            <p class="help-block">Color each pixel by their placer, using the colors defined above.</p>
                        </div>
                    </div>
                    <div class="board-preview__layer-container col-sm-9">
                        <canvas class="board-preview__result-layer"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block css %}
    <link rel="stylesheet" href="{{ base_url() }}/assets/plugins/datatables/jquery.dataTables.min.css">
    <link rel="stylesheet" href="{{ base_url() }}/assets/plugins/datatables/dataTables.bootstrap.css">
    {{ parent() }}
    <style>
        fieldset legend {
            margin: 1em 0 0.5em 0;
        }

        .checkerboard-background {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAIAAAD91JpzAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAVSURBVBhXY1i/fv39+/cZgfjChQsAQicJuS/hrEUAAAAASUVORK5CYII=');
            background-size: cover;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .dynamic-list {
            padding-left: 1em;
        }
        ul.dynamic-list > li {
            list-style: none;
        }

        .coordinate-input-container {
            display: inline-block;
        }
        .coordinate-input-container::before {
            content: "(";
        }
        .coordinate-input-container::after {
            content: ")";
        }
        .coordinate-input-container > input {
            width: 5em;
            border: none;
            border-bottom: 1px solid gray;
        }
        .coordinate-input-container > input::after {
            content: ", ";
        }

        .color-filter > input[type="checkbox"] {
            position: relative;
            margin: 2px;
            width: 2em;
            height: 2em;
            border: 1px solid black;
            appearance: none;
            cursor: pointer;
        }

        .color-filter > input[type="checkbox"]:checked::after {
            position: absolute;
            content: "";
            width: 100%;
            height: 3px;
            bottom: 0;
            background-color: blue;
        }

        .placer-color {
            position: relative;
            padding: 0;
            margin: 0;
            width: 32px;
        }
        .placer-color > input[type="color"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            padding: 0;
            margin: 0;
            appearance: none;
        }

        .board-preview canvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        .board-preview__range {
            font-family: monospace;
        }
        .board-preview__layer-container {
            position: relative;
        }
        .board-preview__result-layer {
            width: 100%;
            box-shadow: 0 0 7px 4px rgba(0, 0, 0, .25);
        }
    </style>
{% endblock css %}

{% block js %}
    {{ parent() }}
    <script src="{{ base_url() }}/assets/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="{{ base_url() }}/assets/plugins/datatables/dataTables.bootstrap.min.js"></script>
    <script src="{{ base_url() }}/assets/plugins/datatables/extensions/Scroller/js/dataTables.scroller.js"></script>
    {% if not had_error %}
    <script type="text/javascript">
        (function() {
            let pxlsInfo; // initialized at the bottom

            const dtPixels = $('#tblPixels').DataTable({
                order: [[4, 'desc']],
                columns: [
                    { data: "pixel_id" },
                    {
                        data: "user_name",
                        render: (data, type, row, meta) => `<a href="/userinfo/${data}">${data}</a>`
                    },
                    {
                        // coordinates
                        render: (data, type, row, meta) => `<a href="{{ webroots.game }}/#x=${row.x}&y=${row.y}&scale=50">(${row.x}, ${row.y})</a>`
                    },
                    {
                        data: "color",
                        render: (data, type, row, meta) => {
                            if (type !== 'display') {
                                return data;
                            }
                            const isInsidePalette = pxlsInfo && data >= 0 && data < pxlsInfo.palette.length;
                            const isTransparent = data === 0xFF;
                            const color = pxlsInfo && pxlsInfo.palette[data];
                            return `<div class="pixel-color"${isInsidePalette ? ` style="background-color: #${color.value}"` : ''}></div> ${isInsidePalette ? color.name : (isTransparent ? 'Transparent' : '???')} (${data})`
                        }
                    },
                    { data: "time" },
                    { data: "most_recent" },
                    { data: "undone" },
                    { data: "undo_action" },
                    { data: "mod_action" },
                    { data: "rollback_action" }
                ]
            });

            $('input[type="checkbox"][data-toggle-column]').on('change', function(ev) {
                const column = parseInt(this.dataset.toggleColumn);
                dtPixels.column(column).visible(this.checked);
            }).change();


            function saveAs(blob, name) {
                const a = document.createElement('a');
                a.download = name || blob.name;
                a.rel = 'noopener';
                a.href = URL.createObjectURL(blob);
                setTimeout(() => URL.revokeObjectURL(a.href), 40 * 1000);
                setTimeout(() => a.dispatchEvent(new MouseEvent('click')));
            }

            function toCSV(data) {
                if (data.length === 0) {
                    return '';
                }

                let result = Object.keys(data[0]).join(',') + '\n';
                for (const pix of data) {
                    result += Object.values(pix) + '\n';
                }
                return result;
            }

            $('#btnExportCSV').on('click', () => {
                const blob = new Blob(
                    [ toCSV(dtPixels.data().toArray()) ],
                    { type: 'application/json' }
                );
                saveAs(blob, 'pixels.csv');
            });
            $('#btnExportJSON').on('click', () => {
                const blob = new Blob(
                    [ JSON.stringify(dtPixels.data().toArray()) + '\n' ],
                    { type: 'application/json' }
                );
                saveAs(blob, 'pixels.json');
            });


            const boardCanvasCtx = $('.board-preview__result-layer')[0].getContext('2d');
            function updatePreviewBoard(data) {
                const { min, max } = data.reduce((acc, { x, y }) => {
                    if (x > acc.max.x) {
                        acc.max.x = x;
                    }
                    if (x < acc.min.x) {
                        acc.min.x = x;
                    }

                    if (y > acc.max.y) {
                        acc.max.y = y;
                    }
                    if (y < acc.min.y) {
                        acc.min.y = y;
                    }

                    return acc;
                }, { min: { x: +Infinity, y: +Infinity }, max: { x: -Infinity, y: -Infinity } });

                $('.board-preview__range .board-preview__range__min').text(`(${min.x}, ${min.y})`);
                $('.board-preview__range .board-preview__range__max').text(`(${max.x}, ${max.y})`);

                const width = max.x - min.x + 1;
                const height = max.y - min.y + 1;
                boardCanvasCtx.canvas.width = width;
                boardCanvasCtx.canvas.height = height;
                boardCanvasCtx.canvas.style.backgroundSize = `${Math.max(1, 100 / width)}%`;

                const id = boardCanvasCtx.getImageData(0, 0, width, height);

                if ($('#cbBoardPreviewUserMode')[0].checked) {
                    // color with user map
                    const userToColor = {};

                    for (const pix of data) {
                        const idx = ((pix.x - min.x) + (pix.y - min.y) * width) * 4;
                        if (id.data[idx] !== 0) {
                            continue;
                        }

                        if (!(pix.user_name in userToColor)) {
                            let c = getPlacerColor(pix.user_name);
                            if (c != null) {
                                c = parseInt(c.substr(1), 16)
                            }
                            userToColor[pix.user_name] = c;
                        }

                        const c = userToColor[pix.user_name];
                        if (c == null) {
                            continue;
                        }
                        id.data[idx  ] = c >> 16 & 0xFF;
                        id.data[idx+1] = c >> 8 & 0xFF;
                        id.data[idx+2] = c & 0xFF;
                        id.data[idx+3] = 255;
                    }
                } else {
                    for (const pix of data) {
                        const idx = ((pix.x - min.x) + (pix.y - min.y) * width) * 4;
                        if (id.data[idx] === 0) {
                            // color with palette
                            if (pix.color >= 0 && pix.color < pxlsInfo.palette.length) {
                                const c = parseInt(pxlsInfo.palette[pix.color].value, 16);
                                id.data[idx  ] = c >> 16 & 0xFF;
                                id.data[idx+1] = c >> 8 & 0xFF;
                                id.data[idx+2] = c & 0xFF;
                                id.data[idx+3] = 255;
                            } else if (pix.color === 0xFF) {
                                id.data[idx] = 127; // half transparency
                            }
                        }
                    }
                }

                boardCanvasCtx.putImageData(id, 0, 0);
            }

            $('#btnBoardPreviewDownload').on('click', () => {
                boardCanvasCtx.canvas.toBlob((blob) => saveAs(blob, 'pixels.png'));
            });
            $('#cbBoardPreviewBackground').on('change', function() {
                boardCanvasCtx.canvas.classList.toggle('checkerboard-background', this.checked)
            }).change();
            $('#cbBoardPreviewUserMode').on('change', () => {
                updatePreviewBoard(dtPixels.data().toArray());
            });

            const isValidDate = (d) => !(d === 'Invalid Date' || isNaN(d));
            const isValidCoord = ([x, y]) => !(isNaN(x) || isNaN(y));

            function parseDateTimeInputs(name) {
                const dateStr = $(`input[type="date"][name="${name}-date"]`).val();
                const timeStr = $(`input[type="time"][name="${name}-time"`).val();
                if (!dateStr && !timeStr) {
                    return null;
                }
                return new Date(`${dateStr} ${timeStr}Z`); // force UTC
            }

            function parseCoordinateInputs(name) {
                const xStr = $(`input[type="number"][name="coords-${name}-x"]`).val();
                const yStr = $(`input[type="number"][name="coords-${name}-y"]`).val();
                if (!xStr && !yStr) {
                    return null;
                }

                return [parseInt(xStr), parseInt(yStr)];
            }

            $('#btnQuery').on('click', function(ev) {
                ev.preventDefault();
                this.disabled = true;
                $('.alert-error').hide();

                let qs = '';
                const qsAdd = (name, value) => {
                    if (qs.length > 0) {
                        qs += '&';
                    }
                    qs += name;
                    if (typeof value !== 'undefined') {
                        qs += `=${encodeURIComponent(value.toString())}`;
                    }
                }

                let invalid = false;
                if ($('.tab-pane.active').attr('id') === 'search-by-id') {
                    const pixelId = $('input[name="pixel-id"]').val();
                    if (pixelId) {
                        qsAdd('pixelId', pixelId);
                    }
                } else {
                    const lblCoordinateFeedback = $('#lblCoordinateFeedback');
                    switch ($('input[type="radio"][name="coordinate-search-type"]:checked').val()) {
                        case 'exact': {
                            const coords = parseCoordinateInputs('exact');
                            if (coords != null) {
                                if (isValidCoord(coords)) {
                                    lblCoordinateFeedback.hide();

                                    const [ x, y ] = coords;
                                    qsAdd('coordsX', x);
                                    qsAdd('coordsY', y);
                                } else {
                                    invalid = true;
                                    lblCoordinateFeedback.show();
                                }
                            }
                            break;
                        }
                        case 'range': {
                            const coordsFrom = parseCoordinateInputs('from');
                            const coordsTo = parseCoordinateInputs('to');
                            if (coordsFrom != null && coordsTo != null) {
                                if (isValidCoord(coordsFrom) && isValidCoord(coordsTo)) {
                                    lblCoordinateFeedback.hide();

                                    const [ fromX, fromY ] = coordsFrom;
                                    qsAdd('coordsFromX', fromX);
                                    qsAdd('coordsFromY', fromY);

                                    const [ toX, toY ] = coordsTo;
                                    qsAdd('coordsToX', toX);
                                    qsAdd('coordsToY', toY);
                                } else {
                                    invalid = true;
                                    lblCoordinateFeedback.show();
                                }
                            }
                        }
                    }

                    const before = parseDateTimeInputs('before');
                    if (before != null) {
                        const lblFeedback = $('#lblBeforeFeedback');
                        if (isValidDate(before)) {
                            lblFeedback.hide();
                            qsAdd('before', before.getTime());
                        } else {
                            invalid = true;
                            lblFeedback.show();
                        }
                    }

                    const after = parseDateTimeInputs('after');
                    if (after != null) {
                        const lblFeedback = $('#lblAfterFeedback');
                        if (isValidDate(after)) {
                            lblFeedback.hide();
                            qsAdd('after', after.getTime());
                        } else {
                            invalid = true;
                            lblFeedback.show();
                        }
                    }

                    const placers = $('input[name="placers[]"]').map((idx, el) => el.value).filter((idx, name) => !!name).toArray();
                    for (const user of placers) {
                        qsAdd('placers[]', user);
                    }

                    const colors = $('#filter-colors input[type="checkbox"]:checked').map((idx, el) => el.dataset.colorIdx).toArray();
                    for (const cIdx of colors) {
                        qsAdd('colors[]', cIdx);
                    }

                    $('.pixel-prop input[type="checkbox"]').each((idx, cb) => {
                        if (cb.checked) {
                            qsAdd(cb.name)
                        }
                    });

                    qsAdd('amount', $('input[name="amount"]').val());
                }

                if (invalid) {
                    return;
                }

                fetch(`{{ xhr_base }}/pixels?${qs}`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                }).then((res) => res.json()).then((json) => {
                    if (json.status !== 'success') {
                        throw json.error;
                    }

                    // Update table
                    dtPixels.clear();
                    dtPixels.rows.add(json.data);
                    dtPixels.draw();

                    // Update graphs
                    if (pxlsInfo.palette) {
                        updatePreviewBoard(json.data);
                        $('.board-preview').show();
                    }
                }).catch((err) => {
                    console.error('Failed to execute query', err);
                    $('#fetch-error-box').show();
                    $('#fetch-error-box .alert-error__text').text('Failed to retrieve the queried pixels.');
                }).finally(() => {
                    this.disabled = false;
                });
            });

            $('input[type="radio"][name="coordinate-search-type"]').on('change', function(ev) {
                const sections = $('[data-section-name="coordinate-search-type"]');
                if (this.checked) {
                    sections.hide();
                }
                sections.filter(`[data-section-value="${this.value}"]`).toggle(this.checked);
            }).change();

            $.fn.DynamicList = function(itemModel) {
                const $this = $(this);
                itemModel = Array.isArray(itemModel) ? itemModel : [itemModel];

                const addBtnEl = $('<button class="btn btn-success"> <i class="icon fa fa-plus"/> Add</button>')
                    .on('click', (ev) => {
                        ev.preventDefault();

                        const itemEl = $('<li class="input-group col-sm-4" />')
                            .append(
                                itemModel.map((el) => el.clone(true)),
                                $('<span class="input-group-btn" />')
                                    .append($('<button class="btn btn-danger"><i class="icon fa fa-times"></i></button>')
                                        .on('click', (ev) => {
                                            ev.preventDefault();
                                            itemEl.remove();
                                        })
                                    )
                            );

                        const addEv = new $.Event('itemAdd', {
                            relatedTarget: itemEl[0]
                        });
                        $this.trigger(addEv);

                        if (!addEv.isDefaultPrevented()) {
                            itemEl.insertBefore(addBtnEl);
                        }
                    });

                $this.addClass('dynamic-list');
                $this.append(addBtnEl);

                return $this;
            }

            const lstPlacers = $('#lstPlacers');
            function getPlacerColor(username) {
                return $('#lstPlacers input').filter((idx, el) => el.value === username).first()
                    .parent().find('.placer-color input').val();
            }
            lstPlacers.DynamicList([
                $('<div class="input-group-addon placer-color" />')
                    .append($('<input type="color" />')),
                $('<input class="form-control" name="placers[]" placeholder="Username" />')
            ]).on('itemAdd', (ev) => {
                $(ev.relatedTarget).find('.placer-color input[type="color"]')
                    .val(`#${Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0')}`);
            });

            const colorFilter = $('#filter-colors');
            function initColorFilter() {
                colorFilter.contents().remove();

                colorFilter.append($(`<input type="checkbox" data-color-idx="255" class="checkerboard-background"/>`));
                for (const idx in pxlsInfo.palette) {
                    const color = pxlsInfo.palette[idx];
                    colorFilter.append($(`<input type="checkbox" data-color-idx="${idx}" />`).css('background-color', `#${color.value}`));
                }
            }

            fetch('{{ webroots.game }}/info')
                .then((res) => res.json())
                .then((info) => { pxlsInfo = info; })
                .then(initColorFilter)
                .catch((err) => {
                    console.error('Failed to fetch game info', err);
                    colorFilter.addClass('text-red').text('Could not retrieve colors from the game.');
                })
                .finally(() => {
                    $('#btnQuery').removeAttr('disabled');
                });
        })();
    </script>
    {% endif %}
{% endblock %}
